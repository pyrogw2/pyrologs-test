(function(){"use strict";const rn=["selfBuffs","groupBuffs","squadBuffs"],cn=n=>n!=null&&n.classification?n.classification==="Boon":!0,ln=n=>`b${n}`,Ln=(n,t)=>{const a=Array.isArray(n==null?void 0:n.activeTimes)?n.activeTimes:[],u=typeof a[0]=="number"?a[0]:0;return u>0?u:t},un=(n,t,a,u,p,C,L)=>{const w=n==="selfBuffs"?1:Math.max(n==="groupBuffs"?C-1:L-1,0);return!w||!p?{generationMs:0,wastedMs:0}:t?{generationMs:a*p*w,wastedMs:u*p*w}:{generationMs:a/100*p*w,wastedMs:u/100*p*w}},Un=n=>{const t=new Map,a=new Map;return n.forEach(C=>{const L=C.details;if(!L)return;const w=L.durationMS||0,B=L.buffMap||{};Object.entries(B).forEach(([g,T])=>{if(!t.has(g)){t.set(g,T);return}const U=t.get(g)||{},k={name:U.name||T.name,stacking:U.stacking??T.stacking,icon:U.icon||T.icon,classification:U.classification||T.classification};t.set(g,k)});const X=(L.players||[]).filter(g=>!g.notInSquad),W=X.length,te=new Map;X.forEach(g=>{const T=g.group??0;te.set(T,(te.get(T)||0)+1)}),X.forEach(g=>{const T=g.account||g.name||g.character_name||"Unknown",U=g.profession||"Unknown",k=g.group??0,M=te.get(k)||1,re=Ln(g,w);a.has(T)||a.set(T,{account:T,profession:U,professions:new Set,professionTimeMs:{},activeTimeMs:0,numFights:0,groupSupported:0,squadSupported:0,boons:{}});const N=a.get(T);N.profession=U,U!=="Unknown"&&(N.professions.add(U),N.professionTimeMs[U]=(N.professionTimeMs[U]||0)+re),N.activeTimeMs+=re,N.numFights+=1,N.groupSupported+=M,N.squadSupported+=W,rn.forEach(V=>{(g[V]||[]).forEach(G=>{var se,I,Fe,pe;if(typeof(G==null?void 0:G.id)!="number")return;const H=ln(G.id),v=B[H];if(!cn(v))return;const fe=(v==null?void 0:v.stacking)??!1,z=((I=(se=G.buffData)==null?void 0:se[0])==null?void 0:I.generation)??0,O=((pe=(Fe=G.buffData)==null?void 0:Fe[0])==null?void 0:pe.wasted)??0,{generationMs:le,wastedMs:oe}=un(V,fe,z,O,w,M,W);!le&&!oe||(t.has(H)||t.set(H,v||{}),N.boons[H]||(N.boons[H]={selfBuffs:{generationMs:0,wastedMs:0},groupBuffs:{generationMs:0,wastedMs:0},squadBuffs:{generationMs:0,wastedMs:0}}),N.boons[H][V].generationMs+=le,N.boons[H][V].wastedMs+=oe)})})})}),{boonTables:Array.from(t.keys()).filter(C=>cn(t.get(C))).map(C=>{const L=t.get(C)||{},w=[];return a.forEach(B=>{var g;const ae=B.boons[C];if(!ae||!rn.some(T=>ae[T].generationMs>0||ae[T].wastedMs>0))return;const W=Array.from(B.professions||[]).filter(T=>T&&T!=="Unknown");let te=B.profession;if(W.length>0){te=W[0];let T=((g=B.professionTimeMs)==null?void 0:g[te])||0;W.forEach(U=>{var M;const k=((M=B.professionTimeMs)==null?void 0:M[U])||0;k>T&&(T=k,te=U)})}w.push({account:B.account,profession:te||"Unknown",professionList:W,activeTimeMs:B.activeTimeMs||1,numFights:B.numFights||1,groupSupported:B.groupSupported||1,squadSupported:B.squadSupported||1,categories:{selfBuffs:{...ae.selfBuffs},groupBuffs:{...ae.groupBuffs},squadBuffs:{...ae.squadBuffs}}})}),{id:C,name:L.name||C,icon:L.icon,stacking:L.stacking??!1,rows:w}}).filter(C=>C.rows.length>0)}},dn=(n,t,a,u,p,C,L={})=>{var g,T,U,k;const B=((n==null?void 0:n[t])||[]).find(M=>M.id===a);if(!B)return{generationMs:0,wastedMs:0};const ae=L[ln(a)],X=(ae==null?void 0:ae.stacking)??!1,W=((T=(g=B.buffData)==null?void 0:g[0])==null?void 0:T.generation)??0,te=((k=(U=B.buffData)==null?void 0:U[0])==null?void 0:k.wasted)??0;return un(t,X,W,te,u,p,C)};var On={methods:{tiered:{tiers:{shortMs:500,mediumMs:1500,weights:{short:.5,medium:1,long:2}}}}};const $n=On,Qe="count",xn=n=>(n||0)/1e3,Wn=(n,t)=>{var p;if(!n)return 0;const a=(p=$n.methods.tiered)==null?void 0:p.tiers;if(!a)return n;const u=t/Math.max(n,1);return u<=a.shortMs?n*a.weights.short:u<=a.mediumMs?n*a.weights.medium:n*a.weights.long},fn=(n,t,a)=>a==="duration"?xn(t):a==="tiered"?Wn(n,t):n;function _n(n,t=Qe){var C;const a=(C=n.statsAll)==null?void 0:C[0],u=Number((a==null?void 0:a.appliedCrowdControl)??0),p=Number((a==null?void 0:a.appliedCrowdControlDuration)??0);return fn(u,p,t)}function Hn(n,t){const a=(t==null?void 0:t.durationMS)||0,u=(t==null?void 0:t.buffMap)||{},p=n.filter(w=>!w.notInSquad),C=p.length,L=new Map;p.forEach(w=>{const B=w.group??0;L.set(B,(L.get(B)||0)+1)}),p.forEach(w=>{const B=L.get(w.group??0)||1,ae=dn(w,"selfBuffs",1122,a,B,C,u),X=dn(w,"squadBuffs",1122,a,B,C,u);w.stabGeneration=(ae.generationMs+X.generationMs)/1e3})}function jn(n){if(!n.statsTargets)return 0;let t=0;for(const a of n.statsTargets)a&&a.length>0&&(t+=a[0].downContribution||0);return t}function Vn(n){if(!n.extBarrierStats||!n.extBarrierStats.outgoingBarrierAllies)return 0;let t=0;for(const a of n.extBarrierStats.outgoingBarrierAllies)if(a)for(const u of a)u&&(t+=u.barrier||0);return t}function zn(n){if(!n.extHealingStats||!n.extHealingStats.outgoingHealingAllies)return 0;let t=0;for(const a of n.extHealingStats.outgoingHealingAllies)if(a)for(const u of a)u&&(t+=u.healing||0);return t}const Kn=n=>{var t,a,u,p;return(((a=(t=n.support)==null?void 0:t[0])==null?void 0:a.condiCleanse)||0)+(((p=(u=n.support)==null?void 0:u[0])==null?void 0:p.condiCleanseSelf)||0)},Gn=(n,t=Qe)=>{var C;const a=(C=n.support)==null?void 0:C[0],u=Number((a==null?void 0:a.boonStrips)??0),p=Number((a==null?void 0:a.boonStripsTime)??0);return fn(u,p,t)},Jn=n=>jn(n),Yn=n=>zn(n),Qn=n=>Vn(n),Xn=(n,t=Qe)=>_n(n,t),Zn=(n,t)=>Hn(n,t),et="count",nt={downContribution:1,healing:1,cleanses:1,strips:1,stability:1,cc:.7,revives:.7,distanceToTag:.7,participation:.7,dodging:.4,dps:.2,damage:.2},tt={showMvp:!0,topSkillDamageSource:"target",topSkillsMetric:"damage"},mn=new Map([["bleeding","Bleeding"],["burning","Burning"],["confusion","Confusion"],["poison","Poison"],["torment","Torment"],["vulnerability","Vulnerability"],["weakness","Weakness"],["weakened","Weakness"],["blind","Blind"],["blinded","Blind"],["blinding","Blind"],["cripple","Cripple"],["crippled","Cripple"],["chill","Chill"],["chilled","Chill"],["immob","Immobilize"],["immobile","Immobilize"],["immobilized","Immobilize"],["slow","Slow"],["slowed","Slow"],["fear","Fear"],["feared","Fear"],["taunt","Taunt"],["taunted","Taunt"]]),ot={Blind:"https://render.guildwars2.com/file/09770136BB76FD0DBE1CC4267DEED54774CB20F6/102837.png",Chill:"https://render.guildwars2.com/file/28C4EC547A3516AF0242E826772DA43A5EAC3DF3/102839.png",Cripple:"https://render.guildwars2.com/file/070325E519C178D502A8160523766070D30C0C19/102838.png",Fear:"https://render.guildwars2.com/file/30307A6E766D74B6EB09EDA12A4A2DE50E4D76F4/102869.png",Immobilize:"https://render.guildwars2.com/file/397A613651BFCA2832B6469CE34735580A2C120E/102844.png",Slow:"https://render.guildwars2.com/file/F60D1EF5271D7B9319610855676D320CD25F01C6/961397.png",Taunt:"https://render.guildwars2.com/file/02EED459AD65FAF7DF32A260E479C625070841B9/1228472.png",Vulnerability:"https://render.guildwars2.com/file/3A394C1A0A3257EB27A44842DDEEF0DF000E1241/102850.png",Weakness:"https://render.guildwars2.com/file/6CB0E64AF9AA292E332A38C1770CE577E2CDE0E8/102853.png"},ze=n=>{if(!n)return null;const t=n.trim().toLowerCase(),a=mn.get(t);if(a)return a;const u=t.split(/[^a-z]+/).filter(Boolean);for(const p of u){const C=mn.get(p);if(C)return C}return null},gn=n=>{const t=new Map;return n&&(Object.values(n).forEach(a=>{if(!(a!=null&&a.icon)||!(a!=null&&a.name))return;const u=ze(a.name);u&&(t.has(u)||t.set(u,a.icon))}),Object.entries(ot).forEach(([a,u])=>{t.has(a)||t.set(a,u)})),t},Ke=(n,t,a)=>{var u;if(t&&a){const p=(u=a[`b${t}`])==null?void 0:u.name,C=ze(p);if(C)return C}return n?ze(n):null},st=n=>{const t=(n==null?void 0:n.account)||"Unknown";return t&&t!=="Unknown"?t:(n==null?void 0:n.name)||"Unknown"||null},it=n=>{if(!n||n.length===0)return 0;let t=0,a=null;return n.forEach(u=>{const p=Number(u[1]??0);if(Number.isFinite(p)){if(a===null){a=p;return}p>a&&(t+=p-a),a=p}}),t},at=n=>{if(!n||n.length===0)return 0;let t=0;return n.forEach(a=>{const u=Number(a[0]??0),p=Number(a[1]??0);Number.isFinite(p)&&u!==0&&p>0&&(t+=1)}),t},rt=n=>{const{players:t,targets:a,skillMap:u,buffMap:p}=n,C=n.getPlayerKey||st,L=gn(p),w={},B={};t.forEach(g=>{if(g!=null&&g.notInSquad)return;const T=C(g);T&&(w[T]||(w[T]={}),g!=null&&g.totalDamageDist&&g.totalDamageDist.forEach(U=>{U&&U.forEach(k=>{if(!k.id)return;let M=`Skill ${k.id}`,re;u&&(u[`s${k.id}`]?(M=u[`s${k.id}`].name||M,re=u[`s${k.id}`].icon||re):u[`${k.id}`]&&(M=u[`${k.id}`].name||M,re=u[`${k.id}`].icon||re));const N=Ke(M,k.id,p);if(!N)return;const V=p==null?void 0:p[`b${k.id}`],K=V==null?void 0:V.name,G=L.get(N)||(V==null?void 0:V.icon),H=M.startsWith("Skill ")?K||N:M,v=re||(V==null?void 0:V.icon),fe=Number(k.connectedHits??0),z=Number(k.hits??0),O=fe>0?fe:z,le=Number(k.totalDamage??0);if(!Number.isFinite(O)&&!Number.isFinite(le))return;const oe=B[N]||{name:N,icon:G,applications:0,damage:0};oe.applications+=Number.isFinite(O)?O:0,oe.damage+=Number.isFinite(le)?le:0,!oe.icon&&G&&(oe.icon=G),B[N]=oe;const se=w[T][N]||{icon:G,applications:0,damage:0,skills:{}};se.applications+=Number.isFinite(O)?O:0,se.damage+=Number.isFinite(le)?le:0;const I=se.skills[H]||{name:H,hits:0,damage:0,icon:v};I.hits+=Number.isFinite(O)?O:0,I.damage+=Number.isFinite(le)?le:0,!I.icon&&v&&(I.icon=v),se.skills[H]=I,!se.icon&&G&&(se.icon=G),w[T][N]=se})}))});const ae=new Map;t.forEach(g=>{if(g!=null&&g.notInSquad)return;const T=C(g);T&&g!=null&&g.name&&ae.set(g.name,T)});let X=0,W=0,te=0;return a.forEach(g=>{g!=null&&g.buffs&&g.buffs.forEach(T=>{const U=Number(T==null?void 0:T.id);if(!Number.isFinite(U))return;const k=p==null?void 0:p[`b${U}`];if((k==null?void 0:k.classification)!=="Condition")return;const M=(k==null?void 0:k.name)||ze(k==null?void 0:k.name);if(!M)return;const re=T.statesPerSource||{};te+=1,Object.entries(re).forEach(([N,V])=>{var z;const K=ae.get(N);if(!K)return;W+=1;const G=it(V),H=at(V);X+=G;const v=((z=w[K])==null?void 0:z[M])||{applications:0,damage:0,skills:{}};v.applicationsFromBuffs=(v.applicationsFromBuffs||0)+G,v.applicationsFromBuffsActive=(v.applicationsFromBuffsActive||0)+H,w[K]=w[K]||{},w[K][M]=v;const fe=B[M]||{name:M,applications:0,damage:0};fe.applicationsFromBuffs=(fe.applicationsFromBuffs||0)+G,fe.applicationsFromBuffsActive=(fe.applicationsFromBuffsActive||0)+H,B[M]=fe})})}),Object.values(w).forEach(g=>{Object.values(g).forEach(T=>{typeof T.applicationsFromBuffs=="number"&&(T.applications=T.applicationsFromBuffs)})}),Object.values(B).forEach(g=>{typeof g.applicationsFromBuffs=="number"&&(g.applications=g.applicationsFromBuffs)}),{playerConditions:w,summary:B,meta:{buffStateApplicationsTotal:X,targetBuffEntriesSeen:te,buffStateSourcesSeen:W}}},ct=[{id:"damage",label:"Damage",field:"damage",source:"dpsAll"},{id:"directDmg",label:"Direct Damage",field:"directDmg",source:"statsTargets"},{id:"connectedDamageCount",label:"Connected Damage Count",field:"connectedDamageCount",source:"statsTargets"},{id:"connectedDirectDamageCount",label:"Connected Direct Damage Count",field:"connectedDirectDamageCount",source:"statsTargets"},{id:"battleStandardHits",label:"Battle Standard Tracking"},{id:"criticalRate",label:"Critical Rate",field:"criticalRate",isRate:!0,isPercent:!0,denomField:"critableDirectDamageCount",source:"statsTargets"},{id:"criticalDmg",label:"Critical Damage",field:"criticalDmg",source:"statsTargets"},{id:"flankingRate",label:"Flanking Rate",field:"flankingRate",isRate:!0,isPercent:!0,denomField:"connectedDirectDamageCount",source:"statsTargets"},{id:"glanceRate",label:"Glance Rate",field:"glanceRate",isRate:!0,isPercent:!0,denomField:"connectedDirectDamageCount",source:"statsTargets"},{id:"missed",label:"Missed",field:"missed",source:"statsTargets"},{id:"evaded",label:"Evaded (enemy)",field:"evaded",source:"statsTargets"},{id:"blocked",label:"Blocked (enemy)",field:"blocked",source:"statsTargets"},{id:"interrupts",label:"Interrupts",field:"interrupts",source:"statsTargets"},{id:"invulned",label:"Invulned",field:"invulned",source:"statsTargets"},{id:"killed",label:"Killed",field:"killed",source:"statsTargets"},{id:"downed",label:"Downed",field:"downed",source:"statsTargets"},{id:"downContribution",label:"Down Contribution",field:"downContribution",source:"statsTargets"},{id:"downContributionPercent",label:"Down Contribution %",isRate:!0,isPercent:!0},{id:"againstDownedDamage",label:"Against Downed Damage",field:"againstDownedDamage",source:"statsTargets"},{id:"appliedCrowdControl",label:"Applied CC",field:"appliedCrowdControl",source:"statsTargets"},{id:"appliedCrowdControlDuration",label:"Applied CC Duration",field:"appliedCrowdControlDuration",source:"statsTargets"},{id:"appliedCrowdControlDownContribution",label:"Applied CC Down Contribution",field:"appliedCrowdControlDownContribution",source:"statsTargets"},{id:"appliedCrowdControlDurationDownContribution",label:"Applied CC Duration Down Contribution",field:"appliedCrowdControlDurationDownContribution",source:"statsTargets"},{id:"boonStrips",label:"Boon Strips",field:"boonStrips",source:"support"}],lt=[{id:"damageTaken",label:"Damage Taken",field:"damageTaken"},{id:"damageTakenCount",label:"Damage Taken Count",field:"damageTakenCount"},{id:"conditionDamageTaken",label:"Condition Damage Taken",field:"conditionDamageTaken"},{id:"conditionDamageTakenCount",label:"Condition Damage Taken Count",field:"conditionDamageTakenCount"},{id:"powerDamageTaken",label:"Power Damage Taken",field:"powerDamageTaken"},{id:"powerDamageTakenCount",label:"Power Damage Taken Count",field:"powerDamageTakenCount"},{id:"downedDamageTaken",label:"Downed Damage Taken",field:"downedDamageTaken"},{id:"downedDamageTakenCount",label:"Downed Damage Taken Count",field:"downedDamageTakenCount"},{id:"damageBarrier",label:"Damage Barrier",field:"damageBarrier"},{id:"damageBarrierCount",label:"Damage Barrier Count",field:"damageBarrierCount"},{id:"blockedCount",label:"Blocked Count",field:"blockedCount"},{id:"evadedCount",label:"Evaded Count",field:"evadedCount"},{id:"missedCount",label:"Missed Count",field:"missedCount"},{id:"dodgeCount",label:"Dodge Count",field:"dodgeCount"},{id:"invulnedCount",label:"Invulnerable Count",field:"invulnedCount"},{id:"interruptedCount",label:"Interrupted Count",field:"interruptedCount"},{id:"downCount",label:"Down Count",field:"downCount"},{id:"deadCount",label:"Death Count",field:"deadCount"},{id:"boonStrips",label:"Boon Strips (Incoming)",field:"boonStrips"},{id:"conditionCleanses",label:"Cleanses (Incoming)",field:"conditionCleanses"},{id:"receivedCrowdControl",label:"Crowd Control (Incoming)",field:"receivedCrowdControl"}],ut=[{id:"condiCleanse",label:"Condition Cleanses",field:"condiCleanse"},{id:"condiCleanseTime",label:"Condition Cleanse Time",field:"condiCleanseTime",isTime:!0},{id:"condiCleanseSelf",label:"Condition Cleanse Self",field:"condiCleanseSelf"},{id:"condiCleanseTimeSelf",label:"Condition Cleanse Time Self",field:"condiCleanseTimeSelf",isTime:!0},{id:"boonStrips",label:"Boon Strips",field:"boonStrips"},{id:"boonStripsTime",label:"Boon Strips Time",field:"boonStripsTime",isTime:!0},{id:"boonStripDownContribution",label:"Boon Strip Down Contribution",field:"boonStripDownContribution"},{id:"boonStripDownContributionTime",label:"Boon Strip Down Contribution Time",field:"boonStripDownContributionTime",isTime:!0},{id:"stunBreak",label:"Stun Breaks",field:"stunBreak"},{id:"removedStunDuration",label:"Removed Stun Duration",field:"removedStunDuration",isTime:!0},{id:"resurrects",label:"Resurrects",field:"resurrects"},{id:"resurrectTime",label:"Resurrect Time",field:"resurrectTime",isTime:!0}],dt=["battle standard","glyph of renewal","glyph of the stars","illusion of life","spirit of nature","nature spirit","search and rescue","signet of mercy"],ft=new Set([10244]),mt=(n,t)=>{var p;if(ft.has(n))return!0;const a=(t==null?void 0:t[`s${n}`])||(t==null?void 0:t[`${n}`]),u=((p=a==null?void 0:a.name)==null?void 0:p.toLowerCase())||"";return dt.some(C=>u.includes(C))},gt=n=>{if(!n||!Number.isFinite(n))return"--:--";const t=Math.max(0,Math.round(n/1e3)),a=Math.floor(t/3600),u=Math.floor(t%3600/60),p=t%60;return a>0?`${a}:${String(u).padStart(2,"0")}:${String(p).padStart(2,"0")}`:`${u}:${String(p).padStart(2,"0")}`},Xe={Guardian:"#72C1D9",Dragonhunter:"#72C1D9",Firebrand:"#72C1D9",Willbender:"#72C1D9",Revenant:"#D16E5A",Herald:"#D16E5A",Renegade:"#D16E5A",Vindicator:"#D16E5A",Warrior:"#FFD166",Berserker:"#FFD166",Spellbreaker:"#FFD166",Bladesworn:"#FFD166",Engineer:"#D09C59",Scrapper:"#D09C59",Holosmith:"#D09C59",Mechanist:"#D09C59",Ranger:"#8CDC82",Druid:"#8CDC82",Soulbeast:"#8CDC82",Untamed:"#8CDC82",Thief:"#C08F95",Daredevil:"#C08F95",Deadeye:"#C08F95",Specter:"#C08F95",Elementalist:"#F68A87",Tempest:"#F68A87",Weaver:"#F68A87",Catalyst:"#F68A87",Mesmer:"#B679D5",Chronomancer:"#B679D5",Mirage:"#B679D5",Virtuoso:"#B679D5",Necromancer:"#52A76F",Reaper:"#52A76F",Scourge:"#52A76F",Harbinger:"#52A76F",Ritualist:"#52A76F",Luminary:"#72C1D9",Conduit:"#D16E5A",Paragon:"#FFD166",Amalgam:"#D09C59",Galeshot:"#8CDC82",Antiquary:"#C08F95",Evoker:"#F68A87",Troubadour:"#B679D5",Unknown:"#64748B"};function pn(n){return Xe[n]||Xe.Unknown}const pt=({logs:n,precomputedStats:t,mvpWeights:a,statsViewSettings:u,disruptionMethod:p})=>{const C=(()=>{const X=n.filter(W=>W.details&&W.details.players&&W.details.players.length>0);return console.log("[useStatsAggregation] Filtering logs:",{total:n.length,passed:X.length,statuses:n.map(W=>W.status),hasDetails:n.map(W=>!!W.details)}),X})(),L=u||tt,w=a||nt,B=(()=>{if(t)return t;const X=p||et,W=L.topSkillDamageSource||"target",te=L.topSkillsMetric||"damage",g=C.length;let T=0,U=0,k=0,M=0,re=0,N=0,V=0,K=0;const G=e=>{const o=((e==null?void 0:e.players)||[]).filter(E=>!E.notInSquad);let b=0,f=0,m=0,S=0;return o.forEach(E=>{var Z;const R=(Z=E.defenses)==null?void 0:Z[0];if(!R)return;const Y=Number(R.downCount||0),ce=Number(R.deadCount||0);b+=Y+ce,m+=ce}),o.forEach(E=>{!E.statsTargets||E.statsTargets.length===0||E.statsTargets.forEach(R=>{const Y=R==null?void 0:R[0];if(!Y)return;const ce=Number(Y.downed||0),Z=Number(Y.killed||0);f+=ce+Z,S+=Z})}),{squadDownsDeaths:b,enemyDownsDeaths:f,squadDeaths:m,enemyDeaths:S}},H=e=>{const{squadDownsDeaths:i,enemyDownsDeaths:o}=G(e);return i>0||o>0?o>i:typeof(e==null?void 0:e.success)=="boolean"?e.success:!1},v=new Map,fe=new Set(["boonStripsTime","condiCleanseTime","condiCleanseTimeSelf"]),z={},O={},le=new Map,oe={},se={},I={},Fe=new Map,pe=new Map,Ge=new Set(Object.keys(Xe)),Je=["Guardian","Revenant","Warrior","Engineer","Ranger","Thief","Elementalist","Mesmer","Necromancer"],je=e=>{if(!e)return"Unknown";const i=String(e).replace(/\s\d+$/,"");if(Ge.has(i))return i;const o=i.toLowerCase();return Je.find(f=>o.includes(f.toLowerCase()))||i||"Unknown"},ht=e=>e!=null&&e.classification?e.classification==="Boon":!0;console.log("[useStatsAggregation] Starting aggregation loop",{validLogsCount:C.length}),C.forEach((e,i)=>{var P,x;const o=e.details;if(!o)return;const b=o.players;console.log(`[useStatsAggregation] Processing log ${i}:`,{playerCount:b==null?void 0:b.length,hasTargets:!!o.targets,firstPlayer:b!=null&&b[0]?{account:b[0].account,notInSquad:b[0].notInSquad}:"none"});const f=o.targets||[],m=o.combatReplayMetaData||{},S=(m==null?void 0:m.inchToPixel)>0?m.inchToPixel:1,E=(m==null?void 0:m.pollingRate)>0?m.pollingRate:1,R=5e3,Y=s=>Array.isArray(s)?s.map(D=>Array.isArray(D)?[Number(D[0]),Number(D[1])]:null).filter(D=>!!D&&Number.isFinite(D[0])):[];let ce=[],Z=o.durationMS||0,Be=!1;const he=b.find(s=>(s==null?void 0:s.hasCommanderTag)&&!(s!=null&&s.notInSquad));(P=he==null?void 0:he.combatReplayData)!=null&&P.positions&&(ce=he.combatReplayData.positions,Y(he.combatReplayData.dead).forEach(([D])=>{D>0&&(Be=!0,Z=Math.min(Z,D))}));const ve=s=>{var ge;const D=(ge=s.statsAll)==null?void 0:ge[0];if((D==null?void 0:D.distToCom)!==void 0&&(D==null?void 0:D.distToCom)!=="Infinity")return Math.round(Number(D.distToCom));if((D==null?void 0:D.stackDist)!==void 0)return Math.round(Number(D.stackDist))||0;if(s.hasCommanderTag)return 0;const F=s.combatReplayData;if(!(F!=null&&F.positions)||!ce.length)return 0;const ke=F.positions,d=Y(F.dead),j=Y(F.down),ie=Math.floor((F.start||0)/E);let Q=0;if(d.length&&j.length)for(const[ue]of d){if(ue<0)continue;const ye=Math.max(0,Math.floor(ue/E))-ie;for(const[we,Me]of j){if(ue!==Me)continue;const Ae=Be&&we>Z?Math.max(1,Math.floor(Z/E)):ye,de=Math.max(0,Math.min(Ae,ke.length,ce.length));if(de<=0)continue;let Ce=0;for(let me=0;me<de;me++){const[Le,Ue]=ke[me],[Oe,$e]=ce[me];Ce+=Math.hypot(Le-Oe,Ue-$e)}Q=Math.round(Ce/de/S)}}return Q},ee=b.filter(s=>!s.notInSquad),Re=b.filter(s=>s.notInSquad);k+=ee.length,M+=f.filter(s=>!s.isFake).length,Zn(b,{durationMS:o.durationMS,buffMap:o.buffMap});const{squadDeaths:Ne,enemyDeaths:We}=G(o);re+=Ne,N+=We,K+=Ne,V+=We,H(o)?T++:U++;const y=o.skillMap?Number((x=Object.keys(o.skillMap).find(s=>{var D,F;return((F=(D=o.skillMap)==null?void 0:D[s])==null?void 0:F.name)==="Battle Standard"}))==null?void 0:x.replace(/^s/,"")):null;b.forEach(s=>{var Ue,Oe,$e,Ve,En,vn,Fn,Bn,Nn,In;if(s.notInSquad)return;const D=s.account||"Unknown",F=D!=="Unknown"?D:s.name||"Unknown",ke=s.name||"Unknown";v.has(F)||v.set(F,{name:ke,account:F,downContrib:0,cleanses:0,strips:0,stab:0,healing:0,barrier:0,cc:0,logsJoined:0,totalDist:0,distCount:0,dodges:0,downs:0,deaths:0,totalFightMs:0,offenseTotals:{},offenseRateWeights:{},defenseActiveMs:0,defenseTotals:{},supportActiveMs:0,supportTotals:{},healingActiveMs:0,healingTotals:{},profession:s.profession||"Unknown",professions:new Set,professionTimeMs:{},isCommander:!1,damage:0,dps:0,revives:0,outgoingConditions:{},incomingConditions:{}});const d=v.get(F);if(s.hasCommanderTag&&(d.isCommander=!0),s.profession&&s.profession!=="Unknown"){d.profession=s.profession,d.professions.add(s.profession);const r=Array.isArray(s.activeTimes)&&typeof s.activeTimes[0]=="number"?s.activeTimes[0]:o.durationMS||0;d.professionTimeMs[s.profession]=(d.professionTimeMs[s.profession]||0)+r}d.logsJoined++,d.downContrib+=Jn(s),d.cleanses+=Kn(s),d.strips+=Gn(s,X),d.healing+=Yn(s),d.barrier+=Qn(s),d.cc+=Xn(s,X),d.stab+=s.stabGeneration||0;const j=ve(s);j<=R&&(d.totalDist+=j,d.distCount++),(Ue=s.defenses)!=null&&Ue[0]&&(d.dodges+=s.defenses[0].dodgeCount||0,d.downs+=s.defenses[0].downCount||0,d.deaths+=s.defenses[0].deadCount||0),o.durationMS&&(d.totalFightMs+=o.durationMS);const ie=Array.isArray(s.activeTimes)&&typeof s.activeTimes[0]=="number"?s.activeTimes[0]:o.durationMS||0;d.defenseActiveMs+=ie,d.supportActiveMs+=ie,d.healingActiveMs+=ie,Array.isArray(s.buffUptimes)&&s.buffUptimes.length>0&&s.buffUptimes.forEach(r=>{var Pn,Rn,yn,qn;if(typeof(r==null?void 0:r.id)!="number")return;const c=`b${r.id}`,h=((Pn=o.buffMap)==null?void 0:Pn[c])||((Rn=o.buffMap)==null?void 0:Rn[String(r.id)]);if(!h||ht(h))return;const q=Number(((qn=(yn=r.buffData)==null?void 0:yn[0])==null?void 0:qn.uptime)??0);if(!Number.isFinite(q)||q<=0)return;const ne=(h==null?void 0:h.stacking)??!1,Ie=(ne?q:q/100)*ie;if(!Number.isFinite(Ie)||Ie<=0)return;Fe.has(c)||Fe.set(c,{name:h==null?void 0:h.name,stacking:ne,icon:h==null?void 0:h.icon}),pe.has(c)||pe.set(c,new Map);const qe=pe.get(c),Pe=d.account||s.account||s.name||"Unknown";let De=qe.get(Pe);De||(De={account:Pe,profession:d.profession||s.profession||"Unknown",professions:new Set,professionTimeMs:{},totalMs:0,durationMs:0},qe.set(Pe,De));const He=s.profession||d.profession;He&&He!=="Unknown"&&(De.professions.add(He),De.professionTimeMs[He]=(De.professionTimeMs[He]||0)+ie,De.profession=He),De.totalMs+=Ie,De.durationMs+=ie}),(Oe=s.defenses)!=null&&Oe[0]&&lt.forEach(r=>{const c=Number(s.defenses[0][r.field]??0);Number.isFinite(c)&&(d.defenseTotals[r.id]=(d.defenseTotals[r.id]||0)+c)}),($e=s.support)!=null&&$e[0]&&ut.forEach(r=>{let c=Number(s.support[0][r.field]??0);Number.isFinite(c)&&(fe.has(r.field)&&c>999999&&(c=0),d.supportTotals[r.id]=(d.supportTotals[r.id]||0)+c)});const Q=(r,c)=>{Number.isFinite(c)&&(d.healingTotals[r]=(d.healingTotals[r]||0)+c)};if(Array.isArray(s.rotation)){let r=0;s.rotation.forEach(c=>{var q;if(!(c!=null&&c.id)||!mt(c.id,o.skillMap))return;const h=((q=c.skills)==null?void 0:q.length)||0;h>0&&(r+=h,Q(`resUtility_s${c.id}`,h))}),r>0&&Q("resUtility",r)}const ge=(Ve=s.statsAll)==null?void 0:Ve[0],ue=(En=s.dpsAll)==null?void 0:En[0],ye=(vn=s.support)==null?void 0:vn[0];if(ct.forEach(r=>{if(r.id==="downContributionPercent"||!r.field)return;let c=0,h=0;r.source==="dpsAll"&&ue?c=Number(ue[r.field]??0):r.source==="statsAll"&&ge?(c=Number(ge[r.field]??0),h=Number(ge[r.denomField||r.weightField||"connectedDamageCount"]??0)):r.source==="support"&&ye?c=Number(ye[r.field]??0):s.statsTargets&&s.statsTargets.forEach(q=>{q!=null&&q[0]&&(c+=Number(q[0][r.field]??0),h+=Number(q[0][r.denomField||r.weightField||"connectedDamageCount"]??0))}),Number.isFinite(c)&&(d.offenseTotals[r.id]=(d.offenseTotals[r.id]||0)+c,r.isRate&&h>0&&(d.offenseRateWeights[r.id]=(d.offenseRateWeights[r.id]||0)+h))}),s.targetDamageDist&&Number.isFinite(y)){const r=s.targetDamageDist.flatMap(c=>c||[]).flatMap(c=>c||[]).reduce((c,h)=>h!=null&&h.id&&h.id===y?c+((h==null?void 0:h.connectedHits)||0):c,0);d.offenseTotals.battleStandardHits=(d.offenseTotals.battleStandardHits||0)+r}d.revives+=((Bn=(Fn=s.support)==null?void 0:Fn[0])==null?void 0:Bn.resurrects)||0,ue&&(d.damage+=ue.damage||0,d.dps+=ue.dps||0);const we=r=>{var ne,_e,Ie,qe;let c=`Skill ${r.id}`;const h=((ne=o.skillMap)==null?void 0:ne[`s${r.id}`])||((_e=o.skillMap)==null?void 0:_e[`${r.id}`]);let q=h==null?void 0:h.icon;if(h!=null&&h.name&&(c=h.name),c.startsWith("Skill ")){const Pe=Ke(c,r.id,o.buffMap);Pe&&(c=Pe,q=((qe=(Ie=o.buffMap)==null?void 0:Ie[`b${r.id}`])==null?void 0:qe.icon)||q)}return{name:c,icon:q}},Me=r=>{if(!(r!=null&&r.id))return;const{name:c,icon:h}=we(r);z[r.id]||(z[r.id]={name:c,icon:h,damage:0,hits:0,downContribution:0}),z[r.id].name.startsWith("Skill ")&&!c.startsWith("Skill ")&&(z[r.id].name=c),!z[r.id].icon&&h&&(z[r.id].icon=h),z[r.id].damage+=r.totalDamage,z[r.id].hits+=r.connectedHits,z[r.id].downContribution+=Number(r.downContribution||0)},Ae=s.account||s.name||"Unknown",de=s.profession||"Unknown",Ce=`${Ae}|${de}`;let me=le.get(Ce);me||(me={key:Ce,account:Ae,displayName:Ae,profession:de,professionList:[de],totalFightMs:0,skills:new Map},le.set(Ce,me)),me.professionList.includes(de)||me.professionList.push(de),me.totalFightMs+=o.durationMS||0;const Le=r=>{if(!(r!=null&&r.id))return;const{name:c,icon:h}=we(r),q=`s${r.id}`;let ne=me.skills.get(q);ne||(ne={id:q,name:c,icon:h,damage:0,downContribution:0},me.skills.set(q,ne)),ne.name.startsWith("Skill ")&&!c.startsWith("Skill ")&&(ne.name=c),!ne.icon&&h&&(ne.icon=h),ne.damage+=Number(r.totalDamage||0),ne.downContribution+=Number(r.downContribution||0)};W==="total"?(Nn=s.totalDamageDist)==null||Nn.forEach(r=>{r==null||r.forEach(c=>{Me(c),Le(c)})}):(In=s.targetDamageDist)==null||In.forEach(r=>{r==null||r.forEach(c=>{c==null||c.forEach(h=>{Me(h),Le(h)})})}),s.totalDamageTaken&&s.totalDamageTaken.forEach(r=>{r==null||r.forEach(c=>{var _e,Ie,qe,Pe;if(!(c!=null&&c.id))return;let h=`Skill ${c.id}`;const q=((_e=o.skillMap)==null?void 0:_e[`s${c.id}`])||((Ie=o.skillMap)==null?void 0:Ie[`${c.id}`]);let ne=q==null?void 0:q.icon;if(q!=null&&q.name&&(h=q.name),h.startsWith("Skill ")){const De=Ke(h,c.id,o.buffMap);De&&(h=De,ne=((Pe=(qe=o.buffMap)==null?void 0:qe[`b${c.id}`])==null?void 0:Pe.icon)||ne)}O[c.id]||(O[c.id]={name:h,icon:ne,damage:0,hits:0}),(!O[c.id].name.startsWith("Skill ")||h.startsWith("Skill "))&&(O[c.id].name=h),!O[c.id].icon&&ne&&(O[c.id].icon=ne),O[c.id].damage+=c.totalDamage,O[c.id].hits+=c.hits})})}),Re.forEach(s=>{const D=je(s.profession||s.name);D&&(I[D]=(I[D]||0)+1)});const A=rt({players:b,targets:f,skillMap:o.skillMap,buffMap:o.buffMap,getPlayerKey:s=>s.account&&s.account!=="Unknown"?s.account:s.name||null}),_=gn(o.buffMap);Object.entries(A.playerConditions).forEach(([s,D])=>{const F=v.get(s);F&&Object.entries(D).forEach(([ke,d])=>{const j=F.outgoingConditions[ke]||{applications:0,damage:0,skills:{},icon:d.icon};j.applications+=Number(d.applications||0),j.damage+=Number(d.damage||0),d.applicationsFromBuffs&&(j.applicationsFromBuffs=(j.applicationsFromBuffs||0)+d.applicationsFromBuffs),d.applicationsFromBuffsActive&&(j.applicationsFromBuffsActive=(j.applicationsFromBuffsActive||0)+d.applicationsFromBuffsActive),Object.entries(d.skills||{}).forEach(([ie,Q])=>{const ge=j.skills[ie]||{name:Q.name,hits:0,damage:0,icon:Q.icon};ge.hits+=Number(Q.hits||0),ge.damage+=Number(Q.damage||0),!ge.icon&&Q.icon&&(ge.icon=Q.icon),j.skills[ie]=ge}),!j.icon&&d.icon&&(j.icon=d.icon),F.outgoingConditions[ke]=j})}),Object.entries(A.summary).forEach(([s,D])=>{const F=oe[s]||{name:D.name||s,icon:D.icon,applications:0,damage:0};F.applications+=Number(D.applications||0),F.damage+=Number(D.damage||0),D.applicationsFromBuffs&&(F.applicationsFromBuffs=(F.applicationsFromBuffs||0)+D.applicationsFromBuffs),D.applicationsFromBuffsActive&&(F.applicationsFromBuffsActive=(F.applicationsFromBuffsActive||0)+D.applicationsFromBuffsActive),!F.icon&&D.icon&&(F.icon=D.icon),oe[s]=F}),ee.forEach(s=>{const D=s.account&&s.account!=="Unknown"?s.account:s.name||"Unknown",F=v.get(D);!F||!s.totalDamageTaken||s.totalDamageTaken.forEach(ke=>ke==null?void 0:ke.forEach(d=>{var me,Le,Ue,Oe,$e,Ve;if(!(d!=null&&d.id))return;let j=`Skill ${d.id}`;const ie=((me=o.skillMap)==null?void 0:me[`s${d.id}`])||((Le=o.skillMap)==null?void 0:Le[`${d.id}`]);ie!=null&&ie.name&&(j=ie.name);const Q=Ke(j,d.id,o.buffMap);if(!Q)return;const ge=(Oe=(Ue=o.buffMap)==null?void 0:Ue[`b${d.id}`])==null?void 0:Oe.name,ue=_.get(Q)||((Ve=($e=o.buffMap)==null?void 0:$e[`b${d.id}`])==null?void 0:Ve.icon),ye=(ie==null?void 0:ie.icon)||ue;j.startsWith("Skill ")&&(ge||Q)&&(j=ge||Q);const we=Number(d.hits??0),Me=Number(d.totalDamage??0),Ae=se[Q]||{name:Q,icon:ue,applications:0,damage:0};Ae.applications+=Number.isFinite(we)?we:0,Ae.damage+=Number.isFinite(Me)?Me:0,!Ae.icon&&ue&&(Ae.icon=ue),se[Q]=Ae;const de=F.incomingConditions[Q]||{applications:0,damage:0,skills:{},icon:ue};de.applications+=Number.isFinite(we)?we:0,de.damage+=Number.isFinite(Me)?Me:0;const Ce=de.skills[j]||{name:j,hits:0,damage:0,icon:ye};Ce.hits+=Number.isFinite(we)?we:0,Ce.damage+=Number.isFinite(Me)?Me:0,!Ce.icon&&ye&&(Ce.icon=ye),de.skills[j]=Ce,!de.icon&&ue&&(de.icon=ue),F.incomingConditions[Q]=de}))})});const Ct=g>0?Math.round(k/g):0,Dt=g>0?Math.round(M/g):0,Tt=re>0?(N/re).toFixed(2):N>0?"∞":"0.00",St=V>0?(K/V).toFixed(2):K>0?"∞":"0.00",Sn=(e,i)=>{const b=e.filter(S=>Number.isFinite(S.value)&&(i?S.value>0:S.value>=0)).sort((S,E)=>{const R=i?E.value-S.value:S.value-E.value;return R!==0?R:S.account.localeCompare(E.account)});let f=null,m=0;return b.map((S,E)=>((f===null||S.value!==f)&&(m=E+1,f=S.value),{rank:m,...S}))},nn=Array.from(v.values()).map(e=>{const i=Array.from(e.professions).filter(o=>o!=="Unknown");if(e.professionList=i,i.length>0){let o=i[0],b=e.professionTimeMs[o]||0;i.forEach(f=>{const m=e.professionTimeMs[f]||0;m>b&&(b=m,o=f)}),e.profession=o}return{key:e.account,stat:e}}),Ye=(e,i)=>{switch(i){case"downContrib":return e.downContrib;case"barrier":return e.barrier;case"healing":return e.healing;case"dodges":return e.dodges;case"strips":return e.strips;case"cleanses":return e.cleanses;case"cc":return e.cc;case"stability":return e.stab;case"revives":return e.revives;case"dps":return e.dps;case"damage":return e.damage;case"participation":return e.logsJoined;case"closestToTag":return!e.isCommander&&e.distCount>0?e.totalDist/e.distCount:Number.POSITIVE_INFINITY;default:return 0}},be=(e,i)=>Sn(nn.map(({stat:o})=>({account:o.account,profession:o.profession,professionList:o.professionList,value:Ye(o,e),count:o.logsJoined})),i),J={downContrib:be("downContrib",!0),barrier:be("barrier",!0),healing:be("healing",!0),dodges:be("dodges",!0),strips:be("strips",!0),cleanses:be("cleanses",!0),cc:be("cc",!0),stability:be("stability",!0),revives:be("revives",!0),participation:be("participation",!0),dps:be("dps",!0),damage:be("damage",!0),closestToTag:be("closestToTag",!1).filter(e=>Number.isFinite(e.value))},kt={downContrib:"downContrib",barrier:"barrier",healing:"healing",dodges:"dodges",strips:"strips",cleanses:"cleanses",cc:"cc",stability:"stability",closestToTag:"closestToTag"},$=e=>{const i=e==null?void 0:e[0];return{value:(i==null?void 0:i.value)??0,player:(i==null?void 0:i.account)??"-",count:(i==null?void 0:i.count)??0,profession:(i==null?void 0:i.profession)??"Unknown",professionList:(i==null?void 0:i.professionList)??[]}},Ee={maxDownContrib:$([]),maxBarrier:$([]),maxHealing:$([]),maxDodges:$([]),maxStrips:$([]),maxCleanses:$([]),maxCC:$([]),maxStab:$([]),closestToTag:$([])},Se={},wt=(e,i)=>{if(i==="closestToTag")return Ye(e,i);const o=Math.max(1,(e.totalFightMs||0)/1e3);return Ye(e,i)/o};Object.values(kt).forEach(e=>{const i=e!=="closestToTag";Se[e]=Sn(nn.map(({stat:o})=>({account:o.account,profession:o.profession,professionList:o.professionList,value:wt(o,e),count:o.logsJoined})),i)}),Ee.maxDownContrib=$(Se.downContrib),Ee.maxBarrier=$(Se.barrier),Ee.maxHealing=$(Se.healing),Ee.maxDodges=$(Se.dodges),Ee.maxStrips=$(Se.strips),Ee.maxCleanses=$(Se.cleanses),Ee.maxCC=$(Se.cc),Ee.maxStab=$(Se.stability),Ee.closestToTag=$(Se.closestToTag);const Mt={maxDownContrib:$(J.downContrib),maxBarrier:$(J.barrier),maxHealing:$(J.healing),maxDodges:$(J.dodges),maxStrips:$(J.strips),maxCleanses:$(J.cleanses),maxCC:$(J.cc),maxStab:$(J.stability),closestToTag:$(J.closestToTag)};let tn={player:"None",account:"None",score:-1,profession:"Unknown",professionList:[],color:"#64748b",topStats:[]},kn,wn,Mn=0;if(L!=null&&L.showMvp){const e={"Down Contribution":"downContribution",Healing:"healing",Cleanses:"cleanses",Strips:"strips",Stability:"stability",CC:"cc",Revives:"revives","Distance to Tag":"distanceToTag",Participation:"participation",Dodging:"dodging",DPS:"dps",Damage:"damage"},i=m=>{const S=e[m];return S?Number(w[S]||0)>0:!1},o=[],b=m=>[...m||[]].filter(S=>i(S==null?void 0:S.name)).sort((S,E)=>E.ratio-S.ratio||S.rank-E.rank||S.name.localeCompare(E.name)).slice(0,3),f=m=>{var E;if(!m)return;const S=b(m.contribs);return{...m,player:m.name,reason:((E=S[0])==null?void 0:E.name)||"Top Performance",topStats:S}};nn.forEach(({stat:m})=>{let S=0;const E=[],R=(Y,ce,Z,Be,he=!0)=>{var ee,Re;if(Z<=0)return;const ve=((ee=ce[0])==null?void 0:ee.value)||0;if(ve&&Number.isFinite(Y)&&(he?Y>0:Y<Number.POSITIVE_INFINITY)){const Ne=he?Y/ve:ve/Y;S+=Ne*Z;const We=((Re=ce.find(l=>l.account===m.account))==null?void 0:Re.rank)||0;E.push({name:Be,ratio:Ne,val:Y.toLocaleString(),rank:We})}};R(m.downContrib,J.downContrib,w.downContribution,"Down Contribution"),R(m.healing,J.healing,w.healing,"Healing"),R(m.cleanses,J.cleanses,w.cleanses,"Cleanses"),R(m.strips,J.strips,w.strips,"Strips"),R(m.stab,J.stability,w.stability,"Stability"),R(m.cc,J.cc,w.cc,"CC"),R(m.revives,J.revives,w.revives,"Revives"),R(Ye(m,"closestToTag"),J.closestToTag,w.distanceToTag,"Distance to Tag",!1),R(m.logsJoined,J.participation,w.participation,"Participation"),R(m.dodges,J.dodges,w.dodging,"Dodging"),R(m.dps,J.dps,w.dps,"DPS"),R(m.damage,J.damage,w.damage,"Damage"),o.push({...m,score:S,contribs:E.filter(Y=>i(Y.name))})}),o.sort((m,S)=>S.score-m.score),o[0]&&o[0].score>0&&(tn=f(o[0])||tn),kn=f(o[1]),wn=f(o[2]),Mn=o.length>0?o.reduce((m,S)=>m+S.score,0)/o.length:0}const At=Object.values(z).sort((e,i)=>{const o=te==="downContribution"?e.downContribution:e.damage;return(te==="downContribution"?i.downContribution:i.damage)-o}).slice(0,25),Et=Object.values(O).sort((e,i)=>i.damage-e.damage).slice(0,25),vt=e=>{const i=String(e).replace(/^Detailed\s*WvW\s*-\s*/i,"").replace(/^World\s*vs\s*World\s*-\s*/i,"").replace(/^WvW\s*-\s*/i,"").trim(),o=i.match(/^(Red|Blue|Green)\s+(?:Alpine|Desert)?\s*Borderlands$/i);return o?`${o[1]} Borderlands`:i||"Unknown"},An=(e,i)=>vt((e==null?void 0:e.zone)||(e==null?void 0:e.mapName)||(e==null?void 0:e.map)||(e==null?void 0:e.location)||(e==null?void 0:e.fightName)||(i==null?void 0:i.fightName)||(i==null?void 0:i.encounterName)||"Unknown"),Ft=(e,i)=>{const o=(i==null?void 0:i.permalink)||(e==null?void 0:e.permalink);if(typeof o=="string"&&o.trim().length>0)return o.trim();const b=e==null?void 0:e.uploadLinks;if(!Array.isArray(b))return"";for(const f of b){if(typeof f=="string"&&f.trim().length>0)return f.trim();if(f&&typeof f=="object"){const m=f.permalink||f.link||f.url||f.reportLink;if(typeof m=="string"&&m.trim().length>0)return m.trim()}}return""},on={};C.forEach(e=>{const i=An(e==null?void 0:e.details,e);on[i]=(on[i]||0)+1});const Bt=Object.entries(on).map(([e,i])=>{const o=String(e).trim(),b=/eternal battlegrounds|^ebg$/i.test(o);let f="#64748b";return b?f="#ffffff":/red/i.test(o)?f="#ef4444":/blue/i.test(o)?f="#3b82f6":/green/i.test(o)&&(f="#22c55e"),{name:e,value:i,color:f}}).sort((e,i)=>i.value-e.value),{boonTables:Nt}=Un(C),It=C.map((e,i)=>{var b,f,m;const o=((b=e.details)==null?void 0:b.players)||[];return{index:i+1,label:`Log ${i+1}`,timestamp:((f=e.details)==null?void 0:f.uploadTime)||0,squadCount:o.filter(S=>!S.notInSquad).length,friendlyCount:o.length,enemies:((m=e.details)==null?void 0:m.targets).filter(S=>!S.isFake).length}}).sort((e,i)=>e.timestamp-i.timestamp),sn={};Array.from(v.values()).forEach(e=>{e.profession&&e.profession!=="Unknown"&&(sn[e.profession]=(sn[e.profession]||0)+1)});const Pt=Object.entries(sn).map(([e,i])=>({name:e,value:i,color:pn(e)})).sort((e,i)=>i.value-e.value),an={};Object.keys(I).length===0&&C.forEach(e=>{var i,o;(o=(i=e.details)==null?void 0:i.targets)==null||o.forEach(b=>{if(b.isFake)return;const f=b.profession&&b.profession!=="Unknown"?b.profession:b.name||b.id||"Unknown",m=je(f);an[m]=(an[m]||0)+1})});const Rt=Object.keys(I).length>0?I:an,yt=Object.entries(Rt).map(([e,i])=>({name:e,value:i,color:pn(e)})).sort((e,i)=>i.value-e.value).slice(0,10),qt=C.map((e,i)=>({log:e,originalIndex:i})).sort((e,i)=>{var o,b;return(((o=e.log.details)==null?void 0:o.uploadTime)||0)-(((b=i.log.details)==null?void 0:b.uploadTime)||0)}).map(({log:e},i)=>{const o=e.details;if(!o)return null;const b=o.players||[],f=b.filter(l=>!l.notInSquad),m=b.filter(l=>l.notInSquad),S=o.targets||[],E=S.filter(l=>!l.isFake),R=f.reduce((l,y)=>{var A,_;return l+(((_=(A=y.dpsAll)==null?void 0:A[0])==null?void 0:_.damage)||0)},0),Y=f.reduce((l,y)=>{var A,_;return l+(((_=(A=y.defenses)==null?void 0:A[0])==null?void 0:_.damageTaken)||0)},0),{enemyDeaths:ce,enemyDownsDeaths:Z}=G(o),Be=H(o),he=o.uploadTime??e.uploadTime??0,ve=An(o,e),ee={red:0,green:0,blue:0},Re=l=>{const y=Number(l);return Number.isFinite(y)?y:0},Ne=l=>{if(!l||typeof l!="object")return;const y=l.teamID??l.teamId??l.team??l.teamColor??l.team_color;if(y!=null)return y;const A=Object.keys(l).find(_=>/^team/i.test(_));return A?l[A]:void 0},We=(l,y)=>{if(l==null)return null;if(typeof l=="string"){const A=l.toLowerCase();return A.includes("red")?"red":A.includes("green")?"green":A.includes("blue")?"blue":A==="r"?"red":A==="g"?"green":A==="b"?"blue":null}if(typeof l=="number")if(y==="zeroBased"){if(l===0)return"red";if(l===1)return"green";if(l===2)return"blue"}else{if(l===1)return"red";if(l===2)return"green";if(l===3)return"blue"}return null};if(o.teamCounts&&typeof o.teamCounts=="object"){const l=o.teamCounts;ee.red=Re(l.red??l.r??l[0]??l[1]),ee.green=Re(l.green??l.g??l[1]??l[2]),ee.blue=Re(l.blue??l.b??l[2]??l[3])}else{const l=[];S.forEach(P=>{if(P!=null&&P.isFake)return;const x=Ne(P);x!=null&&l.push(x)}),b.forEach(P=>{if(!(P!=null&&P.notInSquad))return;const x=Ne(P);x!=null&&l.push(x)}),l.length===0&&b.forEach(P=>{const x=Ne(P);x!=null&&l.push(x)});const y=new Set;l.forEach(P=>{typeof P=="number"&&y.add(P)});const A=y.has(0)?"zeroBased":y.has(3)?"oneBased":"zeroBased";if(l.forEach(P=>{const x=We(P,A);x&&(ee[x]+=1)}),ee.red+ee.green+ee.blue===0&&l.length>0){const P=new Map;l.forEach(s=>{const D=String(s);P.set(D,(P.get(D)||0)+1)});const x=Array.from(P.values()).sort((s,D)=>D-s);ee.red=x[0]||0,ee.green=x[1]||0,ee.blue=x[2]||0}ee.red+ee.green+ee.blue===0&&(ee.red=Math.max(E.length,b.filter(P=>P==null?void 0:P.notInSquad).length))}return{id:e.filePath||`fight-${i}`,label:e.encounterName||`Fight ${i+1}`,permalink:Ft(o,e),timestamp:he,mapName:ve,duration:gt(o.durationMS),isWin:Be,squadCount:f.length,allyCount:m.length,enemyCount:E.length,teamCounts:ee,alliesDown:f.reduce((l,y)=>{var A,_;return l+(((_=(A=y.defenses)==null?void 0:A[0])==null?void 0:_.downCount)||0)},0),alliesDead:f.reduce((l,y)=>{var A,_;return l+(((_=(A=y.defenses)==null?void 0:A[0])==null?void 0:_.deadCount)||0)},0),alliesRevived:f.reduce((l,y)=>{var A,_;return Number(((_=(A=y.statsAll)==null?void 0:A[0])==null?void 0:_.saved)||0)>0?l+1:l},0),rallies:0,enemyDeaths:ce,enemyDowns:Math.max(0,Z-ce),totalOutgoingDamage:R,totalIncomingDamage:Y,incomingBarrierAbsorbed:f.reduce((l,y)=>{var A,_;return l+(((_=(A=y.defenses)==null?void 0:A[0])==null?void 0:_.damageBarrier)||0)},0),outgoingBarrierAbsorbed:f.reduce((l,y)=>{var P;const A=(P=y.extBarrierStats)==null?void 0:P.outgoingBarrier;if(!Array.isArray(A))return l;let _=0;return A.forEach(x=>{if(Array.isArray(x)){x.forEach(s=>{_+=Number((s==null?void 0:s.barrier)||0)});return}_+=Number((x==null?void 0:x.barrier)||0)}),l+_},0)}}).filter(Boolean),Lt=Array.from(pe.entries()).map(([e,i])=>{const o=Fe.get(e)||{},b=Array.from(i.values()).map(f=>{var ce;const m=Array.from(f.professions||[]).filter(Z=>Z&&Z!=="Unknown");let S=f.profession||"Unknown";if(m.length>0){S=m[0];let Z=((ce=f.professionTimeMs)==null?void 0:ce[S])||0;m.forEach(Be=>{var ve;const he=((ve=f.professionTimeMs)==null?void 0:ve[Be])||0;he>Z&&(Z=he,S=Be)})}const E=f.durationMs||0,R=f.totalMs/1e3,Y=E>0?f.totalMs/E:0;return{account:f.account,profession:S,professionList:m,total:R,perSecond:Y,duration:E/1e3}}).filter(f=>f.total>0||f.perSecond>0);return{id:e,name:o.name||e,icon:o.icon,rows:b}}).filter(e=>e.rows.length>0),Ut=Array.from(le.values()).map(e=>{const i=Array.from(e.skills.values()).sort((b,f)=>f.damage-b.damage),o=i.reduce((b,f)=>(b[f.id]=f,b),{});return{key:e.key,account:e.account,displayName:e.displayName,profession:e.profession,professionList:e.professionList,totalFightMs:e.totalFightMs,skills:i,skillMap:o}}).sort((e,i)=>e.displayName.localeCompare(i.displayName));return{total:g,wins:T,losses:U,avgSquadSize:Ct,avgEnemies:Dt,squadKDR:Tt,enemyKDR:St,totalSquadKills:N,totalSquadDeaths:re,totalEnemyKills:K,totalEnemyDeaths:V,leaderboards:J,...Mt,outgoingConditionSummary:Object.values(oe).sort((e,i)=>i.damage-e.damage),incomingConditionSummary:Object.values(se).sort((e,i)=>i.damage-e.damage),outgoingConditionPlayers:Array.from(v.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,conditions:e.outgoingConditions})),incomingConditionPlayers:Array.from(v.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,conditions:e.incomingConditions})),topSkills:At,topIncomingSkills:Et,playerSkillBreakdowns:Ut,topSkillsMetric:te,mapData:Bt,timelineData:It,boonTables:Nt,offensePlayers:Array.from(v.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,offenseTotals:e.offenseTotals,offenseRateWeights:e.offenseRateWeights,totalFightMs:e.totalFightMs})),defensePlayers:Array.from(v.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,defenseTotals:e.defenseTotals,activeMs:e.defenseActiveMs})),supportPlayers:Array.from(v.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,supportTotals:e.supportTotals,activeMs:e.supportActiveMs})),healingPlayers:Array.from(v.values()).map(e=>({account:e.account,profession:e.profession,professionList:e.professionList,healingTotals:e.healingTotals,activeMs:e.healingActiveMs})),mvp:tn,silver:kn,bronze:wn,squadClassData:Pt,enemyClassData:yt,fightBreakdown:qt,specialTables:Lt,topStatsPerSecond:Ee,topStatsLeaderboardsPerSecond:Se,avgMvpScore:Mn}})(),ae=(()=>{const X=new Map,W=new Map,te=[],g=new Map,T=new Map;C.forEach(k=>{const M=k.details;if(!M)return;const re=M.skillMap||{},N=M.fightName||"Log",V=M.uploadTime??k.uploadTime??Date.now(),K={id:k.filePath||k.id||N,label:N,timestamp:V,skillEntries:{},playerActiveSeconds:{},durationSeconds:M.durationMS?M.durationMS/1e3:0};(M.players||[]).forEach(H=>{if(H.notInSquad)return;const v=H.account||H.name||"Unknown",fe=H.profession||"Unknown",z=`${v}|${fe}`;let O=W.get(z);O||(O={key:z,account:v,displayName:v,profession:fe,professionList:[fe],logs:0,totalActiveSeconds:0,skillTotals:{}},W.set(z,O)),O.logs++;const le=(Array.isArray(H.activeTimes)?H.activeTimes[0]:0)/1e3;O.totalActiveSeconds=(O.totalActiveSeconds||0)+le,K.playerActiveSeconds[z]=le,(H.rotation||[]).forEach(oe=>{var Ge,Je,je;if(!(oe!=null&&oe.id))return;const se=((Ge=oe.skills)==null?void 0:Ge.length)||0;if(se<=0)return;const I=`s${oe.id}`,Fe=((Je=re[I])==null?void 0:Je.name)||`Skill ${oe.id}`,pe=(je=re[I])==null?void 0:je.icon;O.skillTotals[I]=(O.skillTotals[I]||0)+se,X.set(I,(X.get(I)||0)+se),g.set(I,Fe),pe&&!T.has(I)&&T.set(I,pe),K.skillEntries[I]||(K.skillEntries[I]={name:Fe,icon:pe,players:{}}),!K.skillEntries[I].icon&&pe&&(K.skillEntries[I].icon=pe),K.skillEntries[I].players[z]=(K.skillEntries[I].players[z]||0)+se})}),te.push(K)});const U=Array.from(X.entries()).map(([k,M])=>({id:k,name:g.get(k)||k,total:M,icon:T.get(k)})).sort((k,M)=>M.total-k.total);return{logRecords:te,players:Array.from(W.values()),skillOptions:U,resUtilitySkills:[]}})();return{validLogs:C,stats:B,skillUsageData:ae}};let Te=null,xe=!1,bn=null,hn=0,Cn=0,Ze=null;const Dn=n=>{if(!n||typeof n!="object")return n;const t=(u,p)=>{const C={};return p.forEach(L=>{u&&Object.prototype.hasOwnProperty.call(u,L)&&(C[L]=u[L])}),C},a=t(n,["players","targets","durationMS","uploadTime","fightName","success","teamCounts","combatReplayMetaData","skillMap","buffMap","encounterDuration"]);return Array.isArray(a.players)&&(a.players=a.players.map(u=>t(u,["name","display_name","character_name","profession","elite_spec","group","dpsAll","statsAll","dpsTargets","statsTargets","defenses","support","rotation","extHealingStats","extBarrierStats","squadBuffVolumes","selfBuffs","groupBuffs","squadBuffs","selfBuffsActive","groupBuffsActive","squadBuffsActive","buffUptimes","totalDamageDist","targetDamageDist","totalDamageTaken","combatReplayData","hasCommanderTag","notInSquad","account","activeTimes"]))),Array.isArray(a.targets)&&(a.targets=a.targets.map(u=>t(u,["id","name","isFake","dpsAll","statsAll","defenses","totalHealth","healthPercentBurned","enemyPlayer"]))),a},bt=n=>{if(!n||typeof n!="object")return n;const t={...n};return n.details?t.details=Dn(n.details):t.details=Dn(n),t},Tn=()=>{if(!xe||!Te)return;xe=!1,hn+=1;const n=Ze;Ze=null;const t=pt(Te);self.postMessage({type:"result",result:t,computeId:hn,logCount:Te.logs.length,token:Cn,completedAt:Date.now(),flushId:n})},en=()=>{bn===null&&(bn=setInterval(()=>{Tn()},5e3))};self.onmessage=n=>{var a,u,p,C;const t=n.data;if((t==null?void 0:t.type)==="reset"){Te={logs:[]},typeof t.token=="number"&&(Cn=t.token),xe=!0,en();return}if((t==null?void 0:t.type)==="settings"){Te={logs:(Te==null?void 0:Te.logs)||[],precomputedStats:(a=t.payload)==null?void 0:a.precomputedStats,mvpWeights:(u=t.payload)==null?void 0:u.mvpWeights,statsViewSettings:(p=t.payload)==null?void 0:p.statsViewSettings,disruptionMethod:(C=t.payload)==null?void 0:C.disruptionMethod},xe=!0,en();return}if((t==null?void 0:t.type)==="log"){Te||(Te={logs:[]}),Te.logs.push(bt(t.payload)),xe=!0,en();return}(t==null?void 0:t.type)==="flush"&&(typeof t.flushId=="number"&&(Ze=t.flushId),xe=!0,Tn())}})();
